- job:
      name: docker-images-deploy
      project-type: flow
      description: |
        Gate job for building, testing and deploying Docker images.
      display-name: 'Gate - Docker image deploy'
      concurrent: false
      triggers:
        - gerrit:
            trigger-on:
                - patchset-created-event
            projects:
                - project-compare-type: 'PLAIN'
                  project-pattern: 'abraverm/logstash-input-bugzilla'
                  branches:
                    - branch-compare-type: 'PLAIN'
                      branch-pattern: 'ci'
                  file-paths:
                    - compare-type: 'ANT'
                      pattern: '**/docker/**'
            skip-vote:
                unstable: true
                notbuilt: true
            trigger-for-unreviewed-patches: true
      node: master
      dsl: |
        retry ( 2 ) {
          build("docker-build-node", gerrit_refspec: params["GERRIT_REFSPEC"])
          parallel (
            {
              build("docker-build-elk-host", gerrit_refspec: params["GERRIT_REFSPEC"])
              build("docker-test-elk", gerrit_refspec: params["GERRIT_REFSPEC"])
            },
            build("docker-build-jjb", gerrit_refspec: params["GERRIT_REFSPEC"]),
            build("docker-build-ruby", gerrit_refspec: params["GERRIT_REFSPEC"])
          )
        }

- job:
    name: docker-build-node
    project-type: freestyle
    description: |
      Gate job which builds a new 'node'.
      Node is a base image which jenkins can run its job on.
    display-name: 'Gate - Docker build node image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          set -x
          pushd "${WORKSPACE}/logstash-input-bugzilla_${BUILD_NUMBER}/docker/node"
          if [ $(git diff --stat "HEAD^" -- . | wc -l) -gt 0 ]; then
            echo "============================"
            echo "Docker - Building Node Image"
            echo "============================"
            docker build -t abraverm/jenkins:node .
          else
            echo "Nothing changed"
          fi

- job:
    name: docker-build-elk-host
    project-type: freestyle
    description: |
      Gate job which builds a new 'elk-host'.
      ELK host is a docker image with docker and other tool enabled for
      running docker inside docker.
    display-name: 'Gate - Docker build ELK-host image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          set -x
          pushd "${WORKSPACE}/logstash-input-bugzilla_${BUILD_NUMBER}/docker/ELK-host"
          if [ $(git diff --stat "HEAD^" -- . | wc -l) -gt 0 ] ||
             [ $(git diff --stat "HEAD^" -- ../node/ | wc -l) -gt 0 ]
          then
            echo "============================"
            echo "Docker - Building ELK-host Image"
            echo "============================"
            docker build -t abraverm/jenkins:docker .
          else
            echo "Nothing changed"
          fi

- job:
    name: docker-test-elk
    project-type: freestyle
    description: |
      Gate job which tests the Docker ELK suite environment.
    display-name: 'Gate - Docker ELK Test'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          set -x
          if [ $(git diff --stat "HEAD^" -- . | wc -l) -gt 0 ] ||
             [ $(git diff --stat "HEAD^" -- ../node/ | wc -l) -gt 0 ] ||
             [ $(git diff --stat "HEAD^" -- "../ELK-host/" | wc -l) -gt 0 ]
          then
            !include-raw ELK.sh
          fi

- job:
    name: docker-build-ruby
    project-type: freestyle
    description: |
      Gate job which builds a new ruby node.
      Ruby node is an image for running code analysis on ruby code.
    display-name: 'Gate - Docker build ruby node image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          set -x
          pushd "${WORKSPACE}/logstash-input-bugzilla_${BUILD_NUMBER}/docker/ruby"
          if [ $(git diff --stat "HEAD^" -- . | wc -l) -gt 0 ] ||
             [ $(git diff --stat "HEAD^" -- ../node/ | wc -l) -gt 0 ]
          then
            echo "================================="
            echo "Docker - Building Ruby Node Image"
            echo "================================="
            docker build -t abraverm/jenkins:ruby .
          else
            echo "Nothing changed"
          fi

- job:
    name: docker-build-jjb
    project-type: freestyle
    description: |
      Gate job which builds a new Jenkins-Job-Builder node.
      Jenkins-Job-Builder is an image for testing jenkins jobs defenition.
    display-name: 'Gate - Docker build JJB node image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          set -x
          pushd "${WORKSPACE}/logstash-input-bugzilla_${BUILD_NUMBER}/docker/jjb"
          if [ $(git diff-index --name-only HEAD | wc -l) -gt 0 ] ||
             [ $(git diff --stat "HEAD^" -- ../node/ | wc -l) -gt 0 ]
          then
            echo "============================"
            echo "Docker - Building JJB Node Image"
            echo "============================"
            docker build -t abraverm/jenkins:jjb .
          else
            echo "Nothing changed"
          fi

