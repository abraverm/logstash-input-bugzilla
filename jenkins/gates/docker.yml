- job:
      name: docker-images-deploy
      project-type: flow
      description: |
        Gate job for building, testing and deploying Docker images.
      display-name: 'Gate - Docker image deploy'
      concurrent: false
      triggers:
        - gerrit:
            trigger-on:
                - patchset-created-event
            projects:
                - project-compare-type: 'PLAIN'
                  project-pattern: 'abraverm/logstash-input-bugzilla'
                  branches:
                    - branch-compare-type: 'PLAIN'
                      branch-pattern: 'ci'
                  file-paths:
                    - compare-type: 'ANT'
                      pattern: '**/docker/**'
            skip-vote:
                unstable: true
                notbuilt: true
            trigger-for-unreviewed-patches: true
      node: master
      dsl: |
        build("docker-build-node")
        parallel (
          {
            build("docker-build-elk-host")
            build("docker-test-elk")
          },
          { build("docker-build-jjb") },
          { build("docker-build-ruby") }
        )

- job:
    name: docker-build-node
    project-type: freestyle
    description: |
      Gate job which builds a new 'node'.
      Node is a base image which jenkins can run its job on.
    display-name: 'Gate - Docker build node image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          pushd "${WORKSPACE}/docker/node"
          echo "============================"
          echo "Docker - Building Node Image"
          echo "============================"
          docker build -t abraverm/jenkins:node .

- job:
    name: docker-build-elk-host
    project-type: freestyle
    description: |
      Gate job which builds a new 'elk-host'.
      ELK host is a docker image with docker and other tool enabled for
      running docker inside docker.
    display-name: 'Gate - Docker build ELK-host image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          pushd "${WORKSPACE}/docker/ELK-host"
          echo "============================"
          echo "Docker - Building ELK-host Image"
          echo "============================"
          docker build -t abraverm/jenkins:docker .

- job:
    name: docker-test-elk
    project-type: freestyle
    description: |
      Gate job which tests the Docker ELK suite environment.
    display-name: 'Gate - Docker ELK Test'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell:
          !include-raw ELK.sh

- job:
    name: docker-build-ruby
    project-type: freestyle
    description: |
      Gate job which builds a new ruby node.
      Ruby node is an image for running code analysis on ruby code.
    display-name: 'Gate - Docker build ruby node image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          pushd "${WORKSPACE}/docker/ruby"
          echo "================================="
          echo "Docker - Building Ruby Node Image"
          echo "================================="
          docker build -t abraverm/jenkins:ruby .

- job:
    name: docker-build-jjb
    project-type: freestyle
    description: |
      Gate job which builds a new Jenkins-Job-Builder node.
      Jenkins-Job-Builder is an image for testing jenkins jobs defenition.
    display-name: 'Gate - Docker build JJB node image'
    concurrent: false
    node: docker
    scm:
      - logstash-input-bugzilla
    builders:
      - shell:
          !include-raw merge.sh
      - shell: |
          pushd "${WORKSPACE}/docker/jjb"
          echo "============================"
          echo "Docker - Building JJB Node Image"
          echo "============================"
          docker build -t abraverm/jenkins:jjb .
